<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Seguretat</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Seguretat\" />");
		document.write("<meta name=\"description\" content=\"Autentificació i autorització d\x27usuaris.\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="http://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Arquitectura CTTI</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a target='_self' class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/principis' data-toggle='_dropdown'>Principis d&#39;arquitectura</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/bloc' data-toggle='_dropdown'>Bloc</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">	
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/canigo-documentacio-versions-3x-core">
											






















										</a>
										
















	<a href="/canigo/">Framework Canigó</a> </li>
	<li>
		<a href="/canigo-documentacio/">Documentació</a>
	</li>

	<li>
		<a href="/canigo-documentacio-versions/">Versions</a>
	</li>
	
	<li>
		<a href="/canigo-documentacio-versions-3x">Versió 3.x</a>
	</li>

	<li>
		
			<a href="/canigo-documentacio-versions-3x-core">Mòduls Generals</a>
		







































									
									</li>
									
									<li>
										Seguretat
									</li>
									

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									
										Seguretat
									
								</h1>

								

								
								
									
								

																	

							</div>
						</div>

					</div>
				</div>
			</article>

			
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	


					

						

<h2 id="propòsit">Propòsit</h2>

<p>El Servei de Seguretat té com a propòsit principal gestionar l&rsquo;autentificació i l&rsquo;autorització dels usuaris de les nostres aplicacions. L&rsquo;objectiu de l&rsquo;autentificació és comprovar que l&rsquo;usuari és qui diu ser, mentre que l&rsquo;autorització s&rsquo;encarrega de comprovar que realment té accés al recurs sol.licitat.</p>

<div class="message warning">
L'especificació JAAS (Java Authorization and Authentication) de J2EE proporciona els mecanismes necessaris de seguretat. Cada servidor d'aplicacions pot implementar l'estàndard però ho fa de diferents formes produint problemes de compatibilitat.  
L'especificació JAAS s'orienta principalment a temes d'autentificació, mentre que els temes d'autorització pateixen de moltes carències.
</div>

<p>Actualment, i a causa del seu grau de maduresa i facilitat Canigó recomana l&rsquo;ús de &lsquo;Spring Security 3.0&rsquo; com framework base i les extensions que Canigó proporciona.</p>

<h2 id="instal-lació-i-configuració">Instal.lació i Configuració</h2>

<h3 id="instal-lació">Instal.lació</h3>

<p>Per tal d&rsquo;instal- lar el mòdul de seguretat es pot incloure automàticament a través de l&rsquo;eina de suport al desenvolupament o bé afegir manualment en el pom.xml de l&rsquo;aplicació la següent dependència:</p>

<pre><code>&lt;canigo.security.version&gt;[1.1.0,1.2.0)&lt;/canigo.security.version&gt;
&lt;spring.security.facelets.tag.support.version&gt;[1.0.0,1.1.0)&lt;/spring.security.facelets.tag.support.version&gt;

&lt;dependency&gt;
    &lt;groupId&gt;cat.gencat.ctti&lt;/groupId&gt;
    &lt;artifactId&gt;canigo.security&lt;/artifactId&gt;
    &lt;version&gt;${canigo.security.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.security.taglibs&lt;/groupId&gt;
    &lt;artifactId&gt;spring.security.facelets.tag.support&lt;/artifactId&gt;
    &lt;version&gt;${spring.security.facelets.tag.support.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h3 id="configuració">Configuració</h3>

<p>La configuració es realitza automàticament a partir de la eina de suport al desenvolupament i es descompon en les parts següents:</p>

<ul>
<li>Configuració dels filtres de l&rsquo;aplicació Web</li>
<li>Configuració de l&rsquo;Autenticació</li>
<li>Configuració de l&rsquo;Autorització</li>
<li>Configuració de la font de dades de l&rsquo;esquema de seguretat</li>
<li>Configuració tags de seguretat en les pàgines</li>
</ul>

<h4 id="configuració-dels-filtres-de-l-aplicació-web">Configuració dels filtres de l&rsquo;aplicació Web</h4>

<p>Spring Security utilitza un conjunt de filtres per a detectar aspectes de l&rsquo;autorització i autentificació. Per a fer-los servir definirem en el fitxer &lsquo;WEB-INF/web.xml el codi següent:</p>

<pre><code>&lt;filter&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;
&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre>

<p>Per a més informació consultar la pàgina <a href="http://static.springsource.org/spring-security/site/docs/3.0.x/reference/security-filter-chain.html">http://static.springsource.org/spring-security/site/docs/3.0.x/reference/security-filter-chain.html</a></p>

<h4 id="configuració-de-l-autenticació">Configuració de l&rsquo;Autenticació</h4>

<p>En la configuració de l&rsquo;Autentificació tindrem en consideració:</p>

<ul>
<li>Seleccionar la configuració de la font en que es realitza l&rsquo;autentificació (per arxiu de propietats, base de dades, LDAP, per servei integrador al servidor corporatiu basat en HTTPS, &hellip;)</li>
<li>Configurar el formulari d&rsquo;autentificació web i la seqüència de cerca on ha de realitzar-se l&rsquo;autentificació.</li>
</ul>

<p>Dins d&rsquo;aquest mòdul trobem els següents proveidors de seguretat:</p>

<ul>
<li>Seguretat InMemory</li>
<li>Seguretat Base de dades</li>
<li>Seguretat LDAP</li>
<li>Seguretat GICAR</li>
<li>Seguretat SACE</li>
</ul>

<p>Els diferents proveidors comparteixen els següents arxius de configuració:</p>

<ul>
<li>security.properties: Propietats del servei de seguretat</li>
<li>app-custom-security.xml: Arxiu XML amb la configuració de seguretat.</li>
<li>security.users.properties: Llistat en format pla dels usuaris/password/rols de l&rsquo;aplicació per al proveidor &ldquo;InMemory&rdquo;.</li>
</ul>

<p>La disposició dels arxius és la següent:</p>

<ul>
<li>Ubicació: <PROJECT_ROOT>/src/main/resources/config/props/security.users.properties</li>
<li>Ubicació: <PROJECT_ROOT>/src/main/resources/spring/app-custom-security.xml</li>
<li>Ubicació: <PROJECT_ROOT>/src/main/resources/config/props/security.properties</li>
</ul>

<pre><code>&lt;security:http pattern=&quot;/css/**&quot; security=&quot;none&quot;/&gt;
&lt;security:http pattern=&quot;/images/**&quot; security=&quot;none&quot;/&gt;
&lt;security:http pattern=&quot;/js/**&quot; security=&quot;none&quot;/&gt;

&lt;!--  Secure patterns --&gt;
&lt;security:http&gt;
    &lt;security:intercept-url pattern=&quot;/**/views/login.xhtml&quot;         access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot; /&gt;
    &lt;security:intercept-url pattern=&quot;/**/views/logout.xhtml&quot;            access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;/&gt;
    &lt;security:intercept-url pattern=&quot;/**/views/monitoring.xhtml&quot;        access=&quot;ROLE_ADMIN&quot; /&gt;
    &lt;security:intercept-url pattern=&quot;/**/views/propertyExpose.xhtml&quot;    access=&quot;ROLE_ADMIN&quot; /&gt;
    &lt;security:intercept-url pattern=&quot;/**/views/moduleList.xhtml&quot;        access=&quot;ROLE_ADMIN&quot; /&gt;
    &lt;security:intercept-url pattern=&quot;/**/views/logReader.xhtml&quot;         access=&quot;ROLE_ADMIN&quot;/&gt;
    &lt;security:intercept-url pattern=&quot;/**/views/**&quot;                  access=&quot;ROLE_USER&quot;/&gt;

        
    &lt;security:form-login    login-processing-url=&quot;/AppJava/j_spring_security_check&quot;
                            login-page=&quot;/AppJava/views/login.xhtml?set-locale=ca_ES&quot; 
                            authentication-failure-url=&quot;/AppJava/views/login.xhtml?set-locale=ca_ES&amp;amp;error=1&quot;/&gt;
    &lt;security:logout logout-url=&quot;/AppJava/views/logout.xhtml&quot; /&gt;
    &lt;security:access-denied-handler error-page=&quot;/views/accessDenied.xhtml&quot;/&gt;
        
&lt;/security:http&gt;
    
&lt;security:authentication-manager&gt;

&lt;!--Proveidor de seguretat--&gt;

&lt;/security:authentication-manager&gt;
</code></pre>

<h4 id="configuració-de-la-font-d-autorització-per-base-de-dades">Configuració de la Font d&rsquo;Autorització per base de dades</h4>

<p>Per a configurar la font d&rsquo;autorització mitjançant base de dades és necessari:</p>

<ul>
<li>Configurar l&rsquo;arxiu de propietats security.properties.</li>
<li>Conigurar el proveidor de seguretat dins de la configuració de seguretat de Spring.</li>
</ul>

<p>Els dos arxius es generen i configuren de manera automàtica mitjançant l&rsquo;eina de desenvolupament.</p>

<p>Les propietats de l&rsquo;arxiu security.properties son les següents:</p>

<table>
<thead>
<tr>
<th>Propietat</th>
<th>Requerit</th>
<th>Descripció</th>
</tr>
</thead>

<tbody>
<tr>
<td>*.security.database.jndiName</td>
<td>Si</td>
<td>Nom JNDI d&rsquo;accés a la BD. Obligatori per a connexions JNDI</td>
</tr>

<tr>
<td>*.security.database.url</td>
<td>Si</td>
<td>URL de connexió a la base de dades</td>
</tr>

<tr>
<td>*.security.database.username</td>
<td>Si</td>
<td>Usuari de connexió a la base de dades</td>
</tr>

<tr>
<td>*.security.database.password</td>
<td>Si</td>
<td>Password de connexió a la base de dades</td>
</tr>
</tbody>
</table>

<p>La configuració del provider en app-custom-security.xml per aquest proveidor és la següent:</p>

<ul>
<li>Afegim el provider al authentication manager.</li>
<li>Afegim el tipus de codificador de password per tal de comparar el password de base de dades i el que ens ha proporcionat l&rsquo;usuari de l&rsquo;aplicació. Aquest codificador suporta: plaintext, sha, sha-256, md5, md4, ssha. Si en la base de dades tenim emmagatzemat els password d&rsquo;usuari en md5, i marquem &ldquo;password-encode&rdquo; com a md5, de manera automàtica, el password proporcionat per l&rsquo;usuari via formulari de login (j_password) es codificarà en md5 per posteriorment ser comparat amb el emmagatzemat a la base de dades.</li>
</ul>

<pre><code>&lt;security:authentication-manager&gt;
    &lt;security:authentication-provider&gt;
                &lt;security:password-encoder hash=&quot;plaintext&quot;/&gt;
        &lt;security:jdbc-user-service data-source-ref=&quot;dataSource&quot;/&gt;
    &lt;/security:authentication-provider&gt;
&lt;/security:authentication-manager&gt;
</code></pre>

<div class="message warning">
Accés base de dades

L'eina de suport al desenvolupament automatitza la instal- lació del mòdul de persistència si aquest no ha estat instal- lat prèviament pel desenvolupador.
</div>

<h4 id="configuració-de-l-autorització-per-sace">Configuració de l&rsquo;Autorització per SACE</h4>

<p>Per a configurar l&rsquo;acces a SACE és necessari:</p>

<ul>
<li>Configurar l&rsquo;arxiu de propietats security.properties.</li>
<li>Conigurar el proveidor de seguretat dins de la configuració de seguretat de Spring.</li>
</ul>

<p>Els dos arxius es generen i configuren de manera automàtica mitjançant l&rsquo;eina de desenvolupament.</p>

<p>Les propietats de l&rsquo;arxiu <strong>security.properties</strong> son les següents:</p>

<table>
<thead>
<tr>
<th>Propietat</th>
<th>Requerit</th>
<th>Descripció</th>
</tr>
</thead>

<tbody>
<tr>
<td>*.security.sace.userNameFormat</td>
<td>No</td>
<td>Format del camp userName. Per defecte: NIF. Valors possibles: NIF, INTERNAL_CODE</td>
</tr>

<tr>
<td>*.security.sace.authoritiesbyUserNameQuery</td>
<td>No</td>
<td>Aquesta propietat permet especificar la query SQL per a recollir els rols dels usuaris</td>
</tr>

<tr>
<td>*.security.sace.keyStore</td>
<td>Si</td>
<td>Localització de la keystore</td>
</tr>

<tr>
<td>*.security.sace.keyStorePassPhrase</td>
<td>Si</td>
<td>Password de la keystore</td>
</tr>

<tr>
<td>*.security.sace.url</td>
<td>Si</td>
<td>URL del servei de SACE</td>
</tr>
</tbody>
</table>

<div class="message warning">
Certificats/keystore<br>
Cal tenir el contenidor de certificats desplegat amb l'aplicació per a poder fer la connexió correctament amb SACE. Per això és important que tingueu aquest fitxer dins el vostre projecte normalment dins "src/main/resources/keystore" i així es desplegarà dins "WEB-INF/classes/keystore". A més cal que configureu les dues propietats "keyStore" i "keyStorePassPhrase". La paraula clau del contenidor que us hemo posat disponible és "saceTrust_pre2007"
</div>

<p>La configuració del proveidor dins de l&rsquo;ariux de <strong>app-custom-security.xml</strong>:</p>

<pre><code>&lt;security:authentication-manager&gt;
    &lt;security:authentication-provider ref=&quot;saceProvider&quot;/&gt;
&lt;/security:authentication-manager&gt;

&lt;bean id=&quot;saceProvider&quot; class=&quot;cat.gencat.ctti.canigo.arch.security.provider.sace.SACEAuthenticationProvider&quot;&gt;
    &lt;description&gt;SACE Provider&lt;/description&gt;
    &lt;property name=&quot;authenticationDao&quot; ref=&quot;saceAuthenticationDao&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;saceAuthenticationDao&quot; class=&quot;cat.gencat.ctti.canigo.arch.security.SACEPasswordAuthenticationDaoStub&quot;&gt;
    &lt;description&gt;SACE Authentication DAO&lt;/description&gt;
    &lt;property name=&quot;i18nResourceBundleMessageSource&quot; ref=&quot;messageSource&quot; /&gt;
    &lt;property name=&quot;userNameFormat&quot; value=&quot;${security.sace.userNameFormat}&quot; /&gt;
    &lt;property name=&quot;hostName&quot; value=&quot;${security.sace.url}&quot; /&gt;
    &lt;property name=&quot;keyStore&quot; value=&quot;${security.sace.keyStore}&quot; /&gt;
    &lt;property name=&quot;keyStorePassPhrase&quot; value=&quot;${security.sace.keyStorePassPhrase}&quot; /&gt;
    &lt;property name=&quot;authoritiesDAO&quot; ref=&quot;saceAuthoritiesDAO&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;saceAuthoritiesDAO&quot; class=&quot;cat.gencat.ctti.canigo.arch.security.provider.sace.authorities.AuthoritiesDAOImpl&quot;&gt;
    &lt;description&gt;Authorities DAO implementation for SACE. Gets granted authorities for specified user&lt;/description&gt;
    &lt;property name=&quot;authoritiesByUsernameQuery&quot; value=&quot;${security.sace.authoritiesbyUserNameQuery:#{null}}&quot;/&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
&lt;/bean&gt;
</code></pre>

<div class="message warning">
Connexió a SACE<br>
Per a realitzar les proves en desenvolupament podem instal- lar un VPN Client per connectar-se al servidor SACE (consultar el document 'Directori Corporatiu de la Generalitat de Catalunya - Guia d'integració d'aplicacions v3.7').ç
</div>

<h4 id="configuració-de-l-autorització-per-ldap">Configuració de l&rsquo;Autorització per LDAP</h4>

<p>Per a configurar l&rsquo;acces a LDAP és necessari:</p>

<ul>
<li>Configurar l&rsquo;arxiu de propietats security.properties.</li>
<li>Conigurar el proveidor de seguretat dins de la configuració de seguretat de Spring.</li>
</ul>

<p>Els dos arxius es generen i configuren de manera automàtica mitjançant l&rsquo;eina de desenvolupament.</p>

<p>Les propietats de l&rsquo;arxiu security.properties son les següents:</p>

<table>
<thead>
<tr>
<th>Propietat</th>
<th>Requerit</th>
<th>Descripció</th>
</tr>
</thead>

<tbody>
<tr>
<td>*.security.ldap.url</td>
<td>Si</td>
<td>Direcció del servidor ldap separat amb dos punts &ldquo;:&rdquo; del port</td>
</tr>

<tr>
<td>*.security.ldap.manager.dn</td>
<td>Sí</td>
<td>Identificador de l&rsquo;usuari administrador del LDAP</td>
</tr>

<tr>
<td>*.security.ldap.manager.password</td>
<td>Si</td>
<td>Password del l&rsquo;usuari administrador del LDAP</td>
</tr>

<tr>
<td>*.security.ldap.user.search.filter</td>
<td>No</td>
<td>Filtre de cerca dels usuaris dintre de l&rsquo;estructura del LDAP. Per defecte: (uid={0})</td>
</tr>

<tr>
<td>*.security.ldap.user.search.base</td>
<td>Si</td>
<td>String base de la ubicació dels usuaris dintre de l&rsquo;estructura del LDAP</td>
</tr>

<tr>
<td>*.security.ldap.group.search.base</td>
<td>Si</td>
<td>String base de la ubicació dels grups dintre de l&rsquo;estructura del LDAP</td>
</tr>

<tr>
<td>*.security.ldap.group.search.filter</td>
<td>No</td>
<td>Filtre de cerca dels grups dintre de l&rsquo;estructura del LDAP. Per defecte: (cn={0})</td>
</tr>
</tbody>
</table>

<p>Per a realitzar les proves en desenvolupament podem instal- lar un servidor LDAP senzill (veure l&rsquo;apartat &lsquo;Eines de Suport&rsquo; per a més referència).</p>

<p>Configuració del provider en <strong>app-custom-security.xml</strong>:</p>

<ul>
<li>Afegim el provider al authentication manager.</li>
<li>Afegim la connexió al LDAP server</li>
</ul>

<pre><code>&lt;security:authentication-manager&gt;
    &lt;security:ldap-authentication-provider
        server-ref=&quot;ldapLocal&quot;
        user-search-filter=&quot;${security.ldap.user.search.filter:(uid={0})}&quot;
        user-search-base=&quot;${security.ldap.user.search.base}&quot;
        group-search-base=&quot;${security.ldap.group.search.base}&quot;
        group-search-filter=&quot;${security.ldap.group.search.filter:(cn={0})}&quot;&gt;

        &lt;security:password-compare/&gt;
    &lt;/security:ldap-authentication-provider&gt;
&lt;/security:authentication-manager&gt;

&lt;security:ldap-server url=&quot;${security.ldap.url}&quot; id=&quot;ldapLocal&quot; manager-dn=&quot;${security.ldap.manager.dn}&quot;
manager-password=&quot;${security.ldap.manager.password}&quot;/&gt;
</code></pre>

<h4 id="configuració-de-l-autorització-per-arxiu-de-propietats">Configuració de l&rsquo;Autorització per arxiu de propietats</h4>

<p>Aquest proveidor de seguretat es recolça en un arxiu de propietats per carregar en memòria els usuaris/password/rols de l&rsquo;aplicació.</p>

<p>Per a configurar l&rsquo;acces mitjançant un arxiu de propietats és necessari:</p>

<ul>
<li>Configurar l&rsquo;arxiu de propietats <strong>security.users.properties</strong>.</li>
<li>Conigurar el proveidor de seguretat dins de la configuració de seguretat de Spring (<strong>app-custom-security.xml</strong>).</li>
</ul>

<p>L&rsquo;arxiu que conté aquesta configuració <strong>security.users.properties</strong> te el següent format:</p>

<pre><code>username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]
</code></pre>

<p>Exemple de configuració:</p>

<pre><code>user=password,ROLE_USER,enabled
admin=password,ROLE_USER,ROLE_ADMIN,enabled
</code></pre>

<h4 id="configuració-del-provider-en-app-custom-security-xml">Configuració del provider en <strong>app-custom-security.xml</strong>:</h4>

<ul>
<li>Afegim el provider al authentication manager.</li>
<li>Afegim el tipus de codificador de password per tal de comparar el password de l&rsquo;arxiu de propietats i el que ens ha proporcionat l&rsquo;usuari de l&rsquo;aplicació. Aquest codificador suporta: plaintext, sha, sha-256, md5, md4, ssha.</li>
</ul>

<pre><code>&lt;security:authentication-manager&gt;
    &lt;security:authentication-provider&gt;
        &lt;security:password-encoder hash=&quot;plaintext&quot;/&gt;
        &lt;security:user-service properties=&quot;classpath:/config/props/security.users.properties&quot;/&gt;
    &lt;/security:authentication-provider&gt;
&lt;/security:authentication-manager&gt;
</code></pre>

<h4 id="configuració-de-la-font-d-autorització-per-gicar">Configuració de la Font d&rsquo;Autorització per GICAR</h4>

<p>Per a configurar l&rsquo;acces a GICAR és necessari:</p>

<ul>
<li>Configurar l&rsquo;arxiu de propietats <strong>security.properties</strong>.</li>
<li>Configurar el proveidor de seguretat dins de la configuració de seguretat de Spring.</li>
</ul>

<p>Els dos arxius es generen i configuren de manera automàtica mitjançant l&rsquo;eina de desenvolupament:</p>

<p>Les propietats de l&rsquo;arxiu <strong>security.properties</strong> son les següents:</p>

<p>Per a configurar l&rsquo;acces a GICAR és necessari configurar l&rsquo;arxiu de propietats <strong>security.properties</strong>. Aquest arxiu es genera automàticament des de l&rsquo;eina de suport, i te el següent format:</p>

<table>
<thead>
<tr>
<th>Propietat</th>
<th>Requerit</th>
<th>Descripció</th>
</tr>
</thead>

<tbody>
<tr>
<td>*.security.gicar.httpGicarHeaderUsernameKey</td>
<td>No</td>
<td>Aquesta propietat indica quin és el camp de la capçalera HTTP_GICAR que conté el nom de l&rsquo;usuari autenticat a GICAR. Per defecte: NIF</td>
</tr>
</tbody>
</table>

<p>La configuració específica del proveidor és el següent:</p>

<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans  xmlns=&quot;http://www.springframework.org/schema/beans&quot;
        xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
        xmlns:security=&quot;http://www.springframework.org/schema/security&quot;
        xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans     http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                           http://www.springframework.org/schema/security   http://www.springframework.org/schema/security/spring-security-3.0.xsd&quot;&gt;

    &lt;security:http pattern=&quot;/css/**&quot; security=&quot;none&quot;/&gt;
    &lt;security:http pattern=&quot;/images/**&quot; security=&quot;none&quot;/&gt;
    &lt;security:http pattern=&quot;/js/**&quot; security=&quot;none&quot;/&gt;

    &lt;!--  Secure patterns --&gt;
    &lt;security:http&gt;
        &lt;security:intercept-url pattern=&quot;/**/views/login.xhtml&quot;             access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot; /&gt;
        &lt;security:intercept-url pattern=&quot;/**/views/logout.xhtml&quot;            access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;/&gt;
        &lt;security:intercept-url pattern=&quot;/**/views/monitoring.xhtml&quot;        access=&quot;ROLE_ADMIN&quot; /&gt;
        &lt;security:intercept-url pattern=&quot;/**/views/propertyExpose.xhtml&quot;    access=&quot;ROLE_ADMIN&quot; /&gt;
        &lt;security:intercept-url pattern=&quot;/**/views/moduleList.xhtml&quot;        access=&quot;ROLE_ADMIN&quot; /&gt;
        &lt;security:intercept-url pattern=&quot;/**/views/logReader.xhtml&quot;         access=&quot;ROLE_ADMIN&quot;/&gt;
        &lt;security:intercept-url pattern=&quot;/**/views/**&quot;                  access=&quot;ROLE_USER&quot;/&gt;


        &lt;security:logout logout-url=&quot;/views/logout.xhtml&quot; /&gt;
        &lt;security:access-denied-handler error-page=&quot;/views/accessDenied.xhtml&quot;/&gt;
        
    &lt;!-- GICAR --&gt;
        &lt;security:form-login login-processing-url=&quot;/j_spring_security_check&quot; login-page=&quot;/j_spring_security_check&quot; /&gt;
        &lt;security:custom-filter ref=&quot;proxyUsernamePasswordAuthenticationFilter&quot; before=&quot;FORM_LOGIN_FILTER&quot; /&gt;
    &lt;/security:http&gt;

    &lt;security:authentication-manager alias=&quot;authenticationManager&quot;&gt;
        &lt;!-- GICAR --&gt;
        &lt;security:authentication-provider ref=&quot;gicarProvider&quot;/&gt;
    &lt;/security:authentication-manager&gt;

    &lt;!-- GICAR --&gt;
    &lt;bean id=&quot;proxyUsernamePasswordAuthenticationFilter&quot; class=&quot;cat.gencat.ctti.canigo.arch.security.authentication.ProxyUsernamePasswordAuthenticationFilter&quot;&gt;
        &lt;property name=&quot;siteminderAuthentication&quot;       value=&quot;true&quot; /&gt;
        &lt;property name=&quot;authenticationManager&quot;          ref=&quot;authenticationManager&quot; /&gt;
        &lt;property name=&quot;authenticationFailureHandler&quot;   ref=&quot;failureHandler&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;failureHandler&quot; class=&quot;org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler&quot;&gt;
        &lt;property name=&quot;defaultFailureUrl&quot; value=&quot;/gicar-error.html&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;gicarProvider&quot; class=&quot;cat.gencat.ctti.canigo.arch.security.provider.siteminder.SiteminderAuthenticationProvider&quot;&gt;
        &lt;description&gt;GICAR Provider&lt;/description&gt;
        &lt;property name=&quot;userDetailsService&quot; ref=&quot;gicarUserDetailsService&quot;/&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;gicarUserDetailsService&quot; class=&quot;cat.gencat.ctti.canigo.arch.security.provider.gicar.GICARUserDetailsServiceImpl&quot;&gt;
        &lt;description&gt;User Detail service implementation for GICAR provider&lt;/description&gt;
        &lt;property name=&quot;httpGicarHeaderUsernameKey&quot; value=&quot;${security.gicar.httpGicarHeaderUsernameKey:NIF}&quot;/&gt;
        &lt;property name=&quot;authoritiesDAO&quot; ref=&quot;authoritiesDAO&quot;/&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;authoritiesDAO&quot; class=&quot;cat.gencat.ctti.canigo.arch.security.provider.sace.authorities.AuthoritiesDAOImpl&quot;&gt;
        &lt;description&gt;Authorities DAO implementation for SACE. Gets granted authorities for specified user&lt;/description&gt;
        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot;/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>

<p>Amb aquesta configuració ha de ser possible autoritzar un usuari que prèviament ha estat auntenticat en el servei de GICAR. Per aquest motiu és necessari rebre certes dades referents a aquesta autenticació ja realitzada. A la capçalera HTML podrem accedir a aquestes dades:</p>

<pre><code>HTTP_GICAR=CODIINTERN=NRDRJN0001;NIF=11112222W;EMAIL=mail.admin@gencat.net;UNITAT_MAJOR=CTTI;
UNITAT_MENOR=CTTI Qualitat
</code></pre>

<p>On CODIINTERN és el codi intern, el NIF el NIF, EMAIL l&rsquo;adreça de correu electrònic registrada al Director Corporatiu, UNITAT_MAJOR és l&rsquo;organització i UNITAT_MENOR és la unitat.</p>

<div class="message warning">
En cas de que l'aplicació utilitzi la separació entre codi estàtic i dinàmic és necessari indicar la següent propietat dintre del bean proxyUsernamePasswordAuthenticationFilter:
<br><br>

<b>&lt;property name="filterProcessesUrl" value="/AppJava/j_spring_security_check" /&gt;</b>

</div>

<p><strong>Logout</strong></p>

<p>Per tots els mètodes d&rsquo;autentificació, el procediment de logoff consisteix en invalidar la sessió, forçant així que el servei de seguretat intervingui en la següent petició solicitant la nova identificació de l&rsquo;usuari.</p>

<p>En el cas de Gicar, però, aquesta autentificació és realitzada per un sistema extern a l&rsquo;aplicació i, per tant, s&rsquo;ha de comunicar a aquest sistema extern la intenció de fer el logoff. El mecanisme previst per fer-ho consisteix en una URL de Gicar que, al ser invocada, realitza el logoff.</p>

<p>Aquest enllaç de logout és depenent de l&rsquo;agent de SiteMinder que l&rsquo;aplicació fa servir per a comunicar-se amb el Policy Server.</p>

<p>Així doncs, els enllaços de logout són els següents:</p>

<ul>
<li>Per a una aplicació ubicada en els apaches corporatius de internet: <a href="http://sso.gencat.cat/siteminderagent/forms/logoff.html">http://sso.gencat.cat/siteminderagent/forms/logoff.html</a></li>
<li>Per a una aplicació ubicada en els apaches corporatius de intranet: <a href="http://sso.gencat.intranet/siteminderagent/forms/logoff.html">http://sso.gencat.intranet/siteminderagent/forms/logoff.html</a></li>
<li>Per a una aplicació amb apache &ldquo;pròpi&rdquo;: http://*<strong><em>.gencat.</em></strong>/siteminderagent/forms/logoff.html;</li>
</ul>

<h4 id="configuració-tags-de-seguretat-en-les-pàgines">Configuració tags de seguretat en les pàgines</h4>

<p>Spring Security permet incorporar tags a les pàgines JSP/JSF per tal de controlar la lògica d&rsquo;aquesta segons els rols de l&rsquo;usuari.</p>

<p>**Configuració JSF</p>

<p>Per a incorporar els tags dins de la JSF s&rsquo;ha de referenciar el espai de noms (nameSpace) de seguretat dins del tag HTML de la pàgina:</p>

<pre><code>&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;
    xmlns:ui=&quot;http://java.sun.com/jsf/facelets&quot;
    xmlns:f=&quot;http://java.sun.com/jsf/core&quot;
    xmlns:h=&quot;http://java.sun.com/jsf/html&quot;
    xmlns:c=&quot;http://java.sun.com/jstl/core&quot;
    xmlns:sec=&quot;http://www.springframework.org/security/facelets/tags&quot;&gt;
....
....
....
&lt;/html&gt;
</code></pre>

<p>Una vegada definida la referència a la llibreria i el seu prefix &lsquo;sec&rsquo;, podem incorporar els següents tags a la pàgina JSF:</p>

<table>
<thead>
<tr>
<th>Propietat</th>
<th>Requerit</th>
<th>Valor</th>
</tr>
</thead>

<tbody>
<tr>
<td>ifAllGranted</td>
<td>No</td>
<td>L&rsquo;usuari ha de tenir tots els rols de l&rsquo;atribut &ldquo;roles&rdquo; perquè el contingut dins del tag (body) sigui mostrat.</td>
</tr>

<tr>
<td>ifAnyGranted:</td>
<td>No</td>
<td>L&rsquo;usuari ha de tenir qualsevol dels rols de l&rsquo;atribut &ldquo;roles&rdquo; perquè el contingut dins del tag (body) sigui mostrat.</td>
</tr>

<tr>
<td>ifNotGranted</td>
<td>No</td>
<td>L&rsquo;usuari no ha de tenir cap dels rols de l&rsquo;atribut &ldquo;roles&rdquo; perquè el contingut dins del tag (body) sigui mostrat.</td>
</tr>
</tbody>
</table>

<p>Exemple:</p>

<pre><code>&lt;sec:ifAnyGranted roles=&quot;ROLE_USER, ROLE_ADMIN&quot;&gt;
    &lt;h:outputText&gt;
       Només visible per usuaris que tinguin el ROLE_USER o ROLE_ADMIN.
       Un usuari amb només el rol ROLE_GESTOR no podria visualitzar el contingut.
    &lt;/h:outputText&gt;
&lt;/sec:ifAnyGranted&gt;

&lt;sec:ifAllGranted roles=&quot;ROLE_USER, ROLE_ADMIN&quot;&gt;
   &lt;h:outputText&gt;Només visible per a usuaris que tinguin els dos rols (ROLE_USER, ROLE_ADMIN) assignats.&lt;/h:outputText&gt;
&lt;/sec:ifAllGranted&gt;

&lt;sec:ifNotGranted roles=&quot;ROLE_USER&quot;&gt;
   &lt;h:outputText&gt;Visible per a usuaris que no tinguin assignat el rol &quot;ROLE_USER&quot;&lt;/h:outputText&gt;&lt;br/&gt;
&lt;/sec:ifNotGranted&gt;
</code></pre>

<p><strong>Configuració Struts/Taglib</strong></p>

<p>Des de la versió JSP 1.2 no és necessari configurar en el fitxer &lsquo;web.xml&rsquo; la referència a les llibreries. Podem referenciar directament per mitjà d&rsquo;una url el jar, tal com es mostra a continuació:</p>

<pre><code>&lt;%@ taglib prefix=&quot;sec&quot; uri=&quot;http://www.springframework.org/security/tags&quot; %&gt;
</code></pre>

<p>Exemple de text només visible per administradors:</p>

<pre><code>&lt;sec:authorize access=&quot;hasRole('ROLE_ADMIN')&quot;&gt;
Text només visible per un administrador
&lt;/sec:authorize&gt;

&lt;sec:authorize access=&quot;hasAnyRole('ROLE_ADMIN, ROLE_USER')&quot;&gt;
Text només visible per un usuari amb rol &quot;ROLE_ADMIN&quot; i/o &quot;ROLE_USER&quot;.
&lt;/sec:authorize&gt;
</code></pre>

<p>Per a més informació sobre el tag &ldquo;sec&rdquo;, consultar la pàgina <a href="http://static.springsource.org/spring-security/site/docs/3.1.x/reference/taglibs.html">Spring Security 3.x Taglib</a></p>

<h2 id="eines-de-suport">Eines de Suport</h2>

<h3 id="servidor-ldap-de-proves-openldap">Servidor LDAP de proves: openLDAP</h3>

<p>Els diferents passos per a instal- lar openLDAP i importar un directori LDAP d&rsquo;exemple són:</p>

<ul>
<li>Baixar openLDAP per a Windows <a href="http://sourceforge.net/projects/openldapwindows/">http://sourceforge.net/projects/openldapwindows/</a> i instal- lar-ho.</li>
<li>Canviar la configuració per defecte de openldap. Copiar les dades següents en un fitxer slapd.conf. Copiarem el slapd.conf en la mateixa carpeta que openLDAP.</li>
</ul>

<pre><code>#######################################################################
# See slapd.conf(5) for details on configuration options.
# This file should NOT be world readable.
#######################################################################
ucdata-path ./ucdata
include ./etc/schema/core.schema
include ./etc/schema/cosine.schema
include ./etc/schema/inetorgperson.schema

# Define global ACLs to disable default read access.

# Do not enable referrals until AFTER you have a working directory
# service AND an understanding of referrals.
#referral ldap://root.openldap.org

pidfile ./var/run/slapd.pid
argsfile ./var/run/slapd.args

#######################################################################
# BDB database definitions
#######################################################################

###database bdb
###suffix &quot;dc=my-domain,dc=com&quot;
###rootdn &quot;cn=Manager,dc=my-domain,dc=com&quot;

database bdb
suffix dc=&quot;mycompany&quot;,dc=&quot;com&quot;
rootdn &quot;cn=Manager,dc=mycompany,dc=com&quot;

rootpw secret
Eines de Suport

directory ./var/openldap-data
index objectClass eq
</code></pre>

<ul>
<li>Obrir una pantalla &ldquo;DOS command&rdquo;, anar a la carpeta on hem instal- lat el programa i arrancar openLDAP amb la comanda</li>
</ul>

<pre><code>.\slapd -d 1
</code></pre>

<p>Si tot ha funcionat bé, hauríem de veure una sortida com la següent:</p>

<p><img src="/related/canigo/documentacio/modul-seguretat/ServeiSeguretat_img012.jpg.gif" alt="Execució Open LDAP" /></p>

<ul>
<li>Copiar les dades següents en un fitxer setup.ldif. Aquest fitxer conté un directori LDAP de l&rsquo;empresa &ldquo;mycompany.com&rdquo; amb 2 persones: &ldquo;gestoruser&rdquo; i &ldquo;usuari&rdquo;. Copiarem el setup.ldif en la mateixa carpeta que openLDAP.</li>
</ul>

<pre><code>### Top level definition
#dn: dc=mycompany,dc=com
#objectClass: top
#objectClass: dcObject
#objectClass: domain
#dc: mycompany

### organizationalUnit : PEOPLE
# Definition of people
dn: ou=people,dc=mycompany,dc=com
objectClass: top
objectClass: organizationalUnit
ou: people

# Gestor User
dn: uid=gestoruser,ou=people,dc=mycompany,dc=com
objectClass: person
objectClass: inetOrgPerson
cn: State App
displayName: App Admin
givenName: App
mail: gestor@fake.org
title: ROLE_ADMIN
sn: Gestor
uid: gestoruser
userPassword: gestorpassword

# usuario normal
dn: uid=usuario,ou=people,dc=mycompany,dc=com
objectClass: person
objectClass: inetOrgPerson
cn: State App
displayName: App Admin
givenName: App
mail: usuario@fake.org
title: ROLE_USER
sn: Usuario
uid: usuario
userPassword: usuariopassword
</code></pre>

<p>Obrir una altra pantalla &ldquo;DOS command&rdquo;, anar a la carpeta on hem instal- lat el programa i importar les dades amb la comanda:</p>

<pre><code>ldapadd -x -D &quot;cn=Manager,dc=mycompany,dc=com&quot; -W -f setup.ldif
</code></pre>

<p>La contrasenya per defecte és &ldquo;secret&rdquo;.</p>

<h3 id="jxplorer">Jxplorer</h3>

<p>Comprovarem que la importació de dades ha funcionat amb Jxplorer, un client LDAP Java i opensource.</p>

<ul>
<li>Baixar Jxplorer a la url <a href="http://sourceforge.net/projects/jxplorer/">http://sourceforge.net/projects/jxplorer/</a> i instal- lar-ho</li>
<li>Prémer el botó per a connectar-se al nostre directori LDAP.</li>
</ul>

<p>La contrasenya per defecte és &ldquo;secret&rdquo;. La pantalla següent mostra els valors de la diferents paràmetres:</p>

<p><img src="/related/canigo/documentacio/modul-seguretat/ServeiSeguretat_img013.jpg.gif" alt="Configuració paràmetres JXplorer" /></p>

<p>Si tot ha funcionat bé, hauríem de veure la pantalla següent:</p>

<p><img src="/related/canigo/documentacio/modul-seguretat/ServeiSeguretat_img014.jpg.gif" alt="Resultat JXplorer" /></p>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="http://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="http://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="http://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="http://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>



</body>
</html>
