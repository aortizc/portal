<!DOCTYPE html>
<html xml:lang="ca-ES" lang="ca-ES" xmlns="http://www.w3.org/1999/xhtml">
<head>

	<title>Mòdul de traces</title>
		<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
	<link href="/css/master.min.css" rel="stylesheet" type="text/css" />
	<link href="/css/canigo.css" rel="stylesheet" type="text/css" />
	<script src="/js/jquery.min.js" type="text/javascript"></script>

	<script>
		document.write("<meta name=\"titol\" content=\"Mòdul de traces\" />");
		document.write("<meta name=\"description\" content=\"Mòdul de detecció d\x27errades.\" />");
	</script>

	

</head>
<body class="single">
	<div class="contenidor unfixed">

				

		<header class="fons_header navbar navbar-default z-index-menu">
			<div class="container" role="menu">
				<div class="row clearfix menuNav">
					<div class="col-md-3 col-xs-3 column visible-xs coloca ">
						<button type="button" onclick="amunt();" title="Menu"
							class="navbar-toggle pull-left" data-toggle="collapse"
							data-target=".navbar-collapse">
							<span class="sr-only">Toggle navigation</span> <span
								class="icon-bar"></span> <span class="icon-bar"></span> <span
								class="icon-bar"></span>
						</button>
					</div>

					<div class="col-md-3 col-xs-6 col-offset-2 column visible-xs titol-mobil">
						
						<span class="white titol-mobil-destacat">canigo.ctti</span><span class="white">.gencat.cat</span>
					</div>

					<div class="col-md-3 col-xs-3 column visible-xs coloca1">
						<button onclick="amunt();" type="button" title="Cerca"
							class="ico_cerca " data-toggle="collapse" data-target=".dos">
						</button>
					</div>

				</div>

				<div class="collapse dos">
					<div class="shadowBox">
						<form class="navbar-form navbar-left primer" action="/cercador/" method="get"
 						onsubmit="location.href=this.action+'?q='+this.cerca_cap.value; return false;">
							<div class="form-group">
								<input type="search" class="form-control" name="q" id="cerca_cap"
									title="Cerca"
									placeholder="Cerca" />
								<button type="button" title="Neteja" class="btn btn-default"></button>
								<input type="submit" class="ocult" name="Cerca" value="Cerca" />
							</div>
						</form>
					</div>
				</div>	

				<nav class="collapse navbar-collapse navbar-ex1-collapse ">
				
					<div class="row">
						<div class="col-md-6 col-sm-4 column">
							<a class="img-responsive logo" title="Generalitat de Catalunya"
								href="http://ctti.gencat.cat/">gencat.cat</a>
							<button class="menu_tancar visible-xs collapsed"
								data-target=".navbar-collapse" data-toggle="collapse"
								title="Tancar"></button>
						</div>

						<div class="col-md-6 col-sm-8 column hidden-xs hidden-mg">
							<form class="navbar-form cercador_vermell hidden-xs pull-right" action="/cercador/"  method="get" onsubmit="location.href=this.action+'?q='+this.cerca2.value; return false;">
								<div class="form-group">
									<label class="hidden" for="cerca2">Cerca</label>
									<input id="cerca2" class="form-control" type="search" 
									placeholder="Cerca" name="q" title="Cerca">
									<input class="btn btn-default" type="submit" title="Cerca" value="">
								</div>
							</form>

							

						</div>

					</div>
					<div class="col-xs-12 hidden-xs" id="nomPortal">
                    	<span class="titol-cap-nou">Arquitectura CTTI</span>
                    </div>					
					<ul class="nav navbar-nav">

			        	

						<li>
							<a target='_self' class="dropdown-toggle" href='/' data-toggle='_dropdown'>Inici</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/principis' data-toggle='_dropdown'>Principis d&#39;arquitectura</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/bloc' data-toggle='_dropdown'>Bloc</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/cloud' data-toggle='_dropdown'>Cloud</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/canigo' data-toggle='_dropdown'>Canigó</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/sic' data-toggle='_dropdown'>SIC</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/sgde' data-toggle='_dropdown'>SGDE</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/gicar' data-toggle='_dropdown'>GICAR</a>
						</li>

						

						<li>
							<a target='_self' class="dropdown-toggle" href='/cs' data-toggle='_dropdown'>Centres de Suport</a>
						</li>

						

					</ul>

				</nav>
			</div>
		</header>



	</div>

	<section class="border-start">

						
			

			<article class="bgGrey">
				<div class="container">	
					<div class="row">
						<div class="capcelera_basica col-sm-12">
							<div class="capcelera_basica_cont">
								<ol class="breadcrumb filariana hidden-xs">
									<li>
										<a href="/">Inici</a>
									</li>
									<li class="breadcrumbs2">
									
										<a href="/canigo-documentacio-versions-3x-core">
											






















										</a>
										
















	<a href="/canigo/">Framework Canigó</a> </li>
	<li>
		<a href="/canigo-documentacio/">Documentació</a>
	</li>

	<li>
		<a href="/canigo-documentacio-versions/">Versions</a>
	</li>
	
	<li>
		<a href="/canigo-documentacio-versions-3x">Versió 3.x</a>
	</li>

	<li>
		
			<a href="/canigo-documentacio-versions-3x-core">Mòduls Generals</a>
		







































									
									</li>
									
									<li>
										Mòdul de traces
									</li>
									

								</ol>

								<h1 class="capcelera_flotant pull-left" data-txt=".title">
									
										Mòdul de traces
									
								</h1>

								

								
								
									
								

																	

							</div>
						</div>

					</div>
				</div>
			</article>

			
			<article class="padding-xs padding-sm padding-md contingut">				
				<div class="container">
 		
					
				

	


					

						

<h2 id="introducció">Introducció</h2>

<h3 id="propósit">Propósit</h3>

<p>El mòdul de traces té com a missió:</p>

<ul>
<li>Detectar i localitzar amb més facilitat errors de l&rsquo;aplicació</li>
<li>Entrada de dades incorrectes segons la lògica del sistema</li>
<li>Seguiment per a auditoria</li>
</ul>

<p>Per a que això pugui ser portat a terme, el servei ofereix la
possibilitat de:</p>

<ol>
<li>Definir nivells de traces (d&rsquo;informació, fatals, errors, etc.)</li>
<li>Definir en quines sortides es generarà la traça: consola, fitxers,
base de dades, correu electrònic, etc.</li>
<li>Canviar en qualsevol moment quin és el mínim nivell de traces que
volem mostrar, sense haver d&rsquo;afectar a les classes que generen les
traces</li>
<li>Definir el format de sortida de les nostres traces: incorporar
l&rsquo;hora, el número de línia del codi on s&rsquo;ha produït i la seva
classe, etc.</li>
<li>Incorporar informació de context a la traça: usuari, IP del client,
etc.</li>
</ol>

<h3 id="documents-i-fonts-de-referència">Documents i Fonts de Referència</h3>

<table>
<thead>
<tr>
<th>Nom</th>
<th>Adreça</th>
</tr>
</thead>

<tbody>
<tr>
<td>Log4J Manual</td>
<td><a href="https://logging.apache.org/log4j/1.2/manual.html">https://logging.apache.org/log4j/1.2/manual.html</a></td>
</tr>

<tr>
<td>JMX i Mbeans</td>
<td><a href="http://download.oracle.com/javase/6/docs/technotes/guides/jmx/tutorial/tutorialTOC.html">http://download.oracle.com/javase/6/docs/technotes/guides/jmx/tutorial/tutorialTOC.html</a></td>
</tr>
</tbody>
</table>

<h3 id="glossari">Glossari</h3>

<p><strong>Log4J</strong></p>

<p>Un dels framework de traces més extés. Es basa en l&rsquo;ús de Appenders,
Categories i Layouts. Veure l&rsquo;annex per a més informació.</p>

<p><strong>JMX</strong></p>

<p>Del acrònim Java Management eXtensions, JMX és la tecnologia que
defineix una arquitectura de gestió, la API, els patrons de disseny, i
els serveis de monitorització/administració d&rsquo;aplicacions Java.</p>

<p><strong>Mbean</strong></p>

<p>Similar al model JavaBeans i amb una interfície estàtica, els Mbeans
exposen mètodes per obtenir i assignar valors remotament i en temps
d&rsquo;execució, ideal per a gestionar modificacions/administració de
propietats en calent.</p>

<h2 id="descripció-detallada">Descripció detallada</h2>

<h3 id="arquitectura-i-components">Arquitectura i components</h3>

<p>A més de les funcionalitats oferides per la pròpia API de Log4j, Canigó
disposa d&rsquo;un conjunt de components addicionals:</p>

<ol>
<li>Configuració de traces multientorn.</li>
<li>MBean per a modificar el nivell de traces en calent d&rsquo;una aplicació.</li>
<li>Layout per a traces amb format XML.</li>
<li>Eina de consulta de logs en calent.</li>
<li>Afegir informació contextual als logs.</li>
</ol>

<h3 id="instal-lació-i-configuració">Instal- lació i configuració</h3>

<h4 id="instal-lació">Instal- lació</h4>

<p>El mòdul de traces s&rsquo;inclou per defecte dins del core de Canigó 3.
Durant el procés de creació de l&rsquo;aplicació (Struts o JSF), l&rsquo;eina de
suport al desenvolupament inclourà la referència dins del pom.xml. En
cas d&rsquo;una instal- lació manual afegir les següents línies al pom.xml de
l&rsquo;aplicació:</p>

<pre><code class="language-java">&lt;canigo.core.version&gt;[3.1.0,3.2.0)&lt;/canigo.core.version&gt;

&lt;dependency&gt;
          &lt;groupId&gt;cat.gencat.ctti&lt;/groupId&gt;
          &lt;artifactId&gt;canigo.core&lt;/artifactId&gt;
          &lt;version&gt;${canigo.core.version}&lt;/version&gt;
</code></pre>

<h4 id="configuració">Configuració</h4>

<p>L&rsquo;eina de desenvolupament de Canigó 3 genera de manera automàtica els
diferents arxius de configuració de traces per entorn:</p>

<ul>
<li>log4j.int.xml Arxiu de configuració per al entorn d&rsquo;integració.</li>
<li>log4j.pre.xml Arxiu de configuració per al entorn de preproducció.</li>
<li>log4j.pro.xml Arxiu de configuració per al entorn de producció.</li>
<li>log4j.xml Arxiu de configuració per defecte. En el cas de no trobar
cap configuració específica per al entorn, aquesta pasarà a ser la
per defecte.</li>
</ul>

<p>Directori de configuració: <PROJECT_ROOT>/src/main/resources/log4j/*.xml</p>

<p>Per cadascun dels entorns els nivells de logs varien.</p>

<p>Exemple de configuració log4j.xml en local:</p>

<pre><code class="language-xml">&lt;log4j:configuration xmlns:log4j='http://jakarta.apache.org/log4j/'
 debug=&quot;true&quot;&gt;

    &lt;!-- Architecture appender --&gt;
    &lt;appender name=&quot;file&quot; class=&quot;org.apache.log4j.DailyRollingFileAppender&quot;&gt;
        &lt;param name=&quot;DatePattern&quot; value=&quot;'.'yyyyMMdd&quot; /&gt;
        &lt;param name=&quot;File&quot;
            value=&quot;/export/AppJavaDades/AppExemple-${weblogic.Name}.log&quot; /&gt;
        &lt;param name=&quot;Append&quot; value=&quot;true&quot; /&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot;
                value=&quot;canigo Message: %d{dd MMM yyyy HH:mm:ss,SSS} %-5p [%t] %c - %m%n - %X{APPID}&quot; /&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;
    &lt;appender name=&quot;console&quot; class=&quot;org.apache.log4j.ConsoleAppender&quot;&gt;
        &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
            &lt;param name=&quot;ConversionPattern&quot;
                value=&quot;canigo Message: %d{dd MMM yyyy HH:mm:ss,SSS} %-5p [%t] %c - %m%n - %X{APPID}&quot; /&gt;
        &lt;/layout&gt;
    &lt;/appender&gt;
    &lt;category name=&quot;cat.gencat.ctti.canigo.arch&quot;&gt;
        &lt;level value=&quot;debug&quot; /&gt;
        &lt;appender-ref ref=&quot;console&quot; /&gt;
        &lt;appender-ref ref=&quot;file&quot; /&gt;
    &lt;/category&gt;
    &lt;root&gt;
                &lt;appender-ref ref=&quot;console&quot; /&gt;
        &lt;level value=&quot;info&quot; /&gt;
    &lt;/root&gt;
&lt;/log4j:configuration&gt;
</code></pre>

<p>D&rsquo;aquesta configuració d&rsquo;exemple destaquem:</p>

<ul>
<li>Existeixen dos tipus d&rsquo;appender, un que mostrarà la informació per
la consola del servidor d&rsquo;aplicacions, i un altre que inserirà les
traces a un log que rotarà automàticament cada dia.</li>
<li>Les traces provinents del package &ldquo;cat.gencat.ctti.canigo.arch&rdquo; es
visualitzaran tant en la consola d&rsquo;arranc del servidor com a un
arxiu de logs.</li>
<li>Els packages restants (aplicació i llibreries de tercers) es
mostraran només per consola i amb nivell de log INFO.</li>
</ul>

<p>A continuació es mostren les configuracions més comuns de Log4J
(mitjançant appenders) i algunes de més específiques que per la seva
complexitat són necessàries d&rsquo;explicar. En alguns casos, es tracten
d&rsquo;implementacions disponibles en la comunitat, en d&rsquo;altres desenvolupats
específicament per Canigó. Es recomana una lectura prèvia del manual de
log4j per conèixer en detall la configuració de log4j.</p>

<h4 id="appenders">Appenders</h4>

<h5 id="configuració-de-l-ús-de-appender-per-consola">Configuració de l&rsquo;ús de appender per consola</h5>

<p>Classe: org.apache.log4j.ConsoleAppender</p>

<p>S&rsquo;afegeixen les traces traces al &ldquo;System.out&rdquo; o &ldquo;System.err&rdquo;. Per a
informació detallada sobre les propietats de l&rsquo;appender consultar el
manual de Log4J.</p>

<p>Exemple:</p>

<pre><code class="language-xml">&lt;appender name=&quot;console&quot;  class=&quot;org.apache.log4j.ConsoleAppender&quot;&gt;
    &lt;layout  class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
       &lt;param name=&quot;ConversionPattern&quot;  value=&quot;canigo Message: %-5p [%t] %c -  %m%n&quot;/&gt;
    &lt;/layout&gt;
&lt;/appender&gt;
</code></pre>

<h5 id="configuració-de-l-ús-de-appender-per-fitxer-rotatiu"><strong>Configuració de l&rsquo;ús de appender per fitxer rotatiu</strong></h5>

<p>Classe: org.apache.log4j.DailyRollingFileAppender</p>

<p>Permet establir un tamany màxim de fitxer i cada vegada que el fitxer de
log supera aquest tamany es crea un fitxer de traces nou. Aquest procés
es fa diàriament o segons la freqüència especificada. Per a informació
detallada sobre la forma d&rsquo;especificar les diferents freqüències i
propietats de l&rsquo;appender consultar el manual de Log4J.</p>

<p>El format del fitxer (texte pla o XML) el defineix el <em>layout</em> associat
a l&rsquo;<em>appender</em> com veurem posteriorment.</p>

<h5 id="configuració-de-l-ús-de-appender-per-correu-electrònic"><strong>Configuració de l&rsquo;ús de Appender per Correu Electrònic</strong></h5>

<p>Classe: org.apache.log4j.SMTPAppender</p>

<p>Envia les traces per correu electrònic. Per a informació detallada sobre
les propietats de l&rsquo;appender consultar el manual de Log4J.</p>

<h5 id="configuració-de-l-ús-de-appender-per-snmp"><strong>Configuració de l&rsquo;ús de Appender per SNMP</strong></h5>

<p>Classe: org.apache.log4j.ext.SNMPTrapAppender</p>

<p>Envia les traces com a missatges TRAP pel protocol de control de xarxa
SNMP a un administrador de xarxa. El manual de Log4J és molt reticent en
definir el seu ús. Degut a la seva complexitat es fa esmena en aquest
apartat de cóm utilitzar-lo.</p>

<p>Es poden especificar els següents paràmetres:</p>

<table>
<thead>
<tr>
<th><strong>Paràmetre</strong></th>
<th><strong>Requerit</strong></th>
<th><strong>Descripció</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td>ImplementationClassName</td>
<td>Sí</td>
<td>Implementació del protocol snmp. Podem escollir entre dos valors en funció de la versió del protocol que vulguem fer servir: <em>org.apache.log4j.ext.WengsoftSNMPTrapSender</em> (v1,v2 ó v3) ó <em>org.apache.log4j.ext.JoeSNMPTrapSender</em> (v1 ó v2)</td>
</tr>

<tr>
<td>ManagementHost</td>
<td>Sí</td>
<td>Direcció IP del host a on està l&rsquo;administrador de xarxa a on s&rsquo;enviaran els missatges SNMP</td>
</tr>

<tr>
<td>ManagementHostTrapListenPort</td>
<td>Sí</td>
<td>Port a on està l&rsquo;administrador de xarxa a on s&rsquo;enviaran els missatges SNMP</td>
</tr>

<tr>
<td>EnterpriseOID</td>
<td>Sí</td>
<td>paràmetre propi del protocol SNMP</td>
</tr>

<tr>
<td>LocalIPAddress</td>
<td>Sí</td>
<td>IP des d&rsquo;on s&rsquo;envien els missatges</td>
</tr>

<tr>
<td>LocalTrapSendPort</td>
<td>Sí</td>
<td>Port des d&rsquo;on s&rsquo;envien els missatges</td>
</tr>

<tr>
<td>GenericTrapType</td>
<td>Sí</td>
<td>Paràmetre propi del protocol SNMP</td>
</tr>

<tr>
<td>SpecificTrapType</td>
<td>Sí</td>
<td>Paràmetre propi del protocol SNMP</td>
</tr>

<tr>
<td>CommunityString</td>
<td>Sí</td>
<td>Paràmetre propi del protocol SNMP</td>
</tr>

<tr>
<td>Threshold</td>
<td>Sí</td>
<td>Nivell més baix pel que es generaran els missatges TRAP</td>
</tr>
</tbody>
</table>

<p>Exemple:</p>

<pre><code class="language-xml">&lt;appender name=&quot;snmp&quot; class=&quot;org.apache.log4j.ext.SNMPTrapAppender&quot;&gt;
    &lt;param name=&quot;ImplementationClassName&quot; value=&quot;org.apache.
    log4j.ext.WengsoftSNMPTrapSender&quot;/&gt;
    &lt;param name=&quot;ManagementHost&quot; value=&quot;127.0.0.1&quot;/&gt;
    &lt;param name=&quot;ManagementHostTrapListenPort&quot; value=&quot;8001&quot;/&gt;
    &lt;param name=&quot;EnterpriseOID&quot; value=&quot;1.3.6.1.4.1.24.0&quot;/&gt;
    &lt;param name=&quot;LocalIPAddress&quot; value=&quot;127.0.0.1&quot;/&gt;
    &lt;param name=&quot;LocalTrapSendPort&quot; value=&quot;161&quot;/&gt;
    &lt;param name=&quot;GenericTrapType&quot; value=&quot;6&quot;/&gt;
    &lt;param name=&quot;SpecificTrapType&quot; value=&quot;12345678&quot;/&gt;
    &lt;param name=&quot;CommunityString&quot; value=&quot;public&quot;/&gt;
    &lt;param name=&quot;ForwardStackTraceWithTrap&quot; value=&quot;true&quot;/&gt;
    &lt;param name=&quot;Threshold&quot; value=&quot;DEBUG&quot;/&gt;
    &lt;param name=&quot;ApplicationTrapOID&quot; value=&quot;1.3.6.1.4.1.24.12.10.22.64&quot;/&gt;
    &lt;layout class=&quot;org.apache.log4j.ext.SnmpDelimitedConversionPatternLayout&quot;&gt;
    &lt;param name=&quot;ValuePairDelim&quot; value=&quot;/&quot;/&gt;
    &lt;param name=&quot;VarDelim&quot; value=&quot;;&quot;/&gt;
    &lt;param name=&quot;ConversionPattern&quot; value=&quot;%-5p;1.3.6.1.4.1.24.100.1/%t;1.
    3.6.1.4.1.24.100.2/%c;1.3.6.1.4.1.24.100.3/%m;1.3.6.1.4.1.24.100.4&quot; /&gt;
&lt;/layout&gt;
&lt;/appender&gt;
</code></pre>

<h5 id="configuració-de-l-ús-de-appender-per-base-de-dades">Configuració de l&rsquo;ús de Appender per Base de Dades</h5>

<p>Classe: org.apache.log4j.jdbcplus.JDBCAppender</p>

<p>Instal- lació: Per a poder fer ús d&rsquo;aquest appender cal descarregar una
llibreria, disponible a la url
<a href="http://www.dankomannhaupt.de/projects/index.html">http://www.dankomannhaupt.de/projects/index.html</a></p>

<p>Es poden definir els paràmetres:</p>

<table>
<thead>
<tr>
<th><strong>Paràmetre</strong></th>
<th><strong>Requerit</strong></th>
<th><strong>Descripció</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td>url</td>
<td>Sí</td>
<td>Url de connexió a la base de dades</td>
</tr>

<tr>
<td>username</td>
<td>Sí</td>
<td>Nom usuari connexió a la base de dades</td>
</tr>

<tr>
<td>password</td>
<td>Sí</td>
<td>Password connexió a la base de dades</td>
</tr>

<tr>
<td>conector</td>
<td>Sí</td>
<td>Connector a la base de dades. Els valors disponibles són:  1.  org.apache.log4j.jdbcplus.examples.MySqlConnectionHandler  2. org.apache.log4j.jdbcplus.examples.OracleConnectionHandler  En cas de que no es disposi de connector per la base de dades seleccionada es pot realitzar una implementació de la interfície &lsquo;<em>org.apache.log4j.jdbcplus.JDBCConnectionHandler&rsquo;</em></td>
</tr>

<tr>
<td>sqlHandler</td>
<td>Sí</td>
<td>Adaptador que proporciona la cadena per fer la inserció d&rsquo;un registre.  Usar: &lsquo; org.apache.log4j.jdbcplus.examples.SqlHandler &lsquo;</td>
</tr>

<tr>
<td>sql</td>
<td>Sí</td>
<td>Patró d&rsquo;inserció dels valors en la base de dades  (Veure patrons a continuació)</td>
</tr>

<tr>
<td>table</td>
<td>Sí</td>
<td>Taula en la que s&rsquo;emmagatzemaran les traces</td>
</tr>

<tr>
<td>column</td>
<td>Sí</td>
<td>Crear un paràmetre amb nom &lsquo;column&rsquo; per cada columna a inserir. Indicar com a valor:  nom_de_columna~patró~valor  On patró correspon a un dels possibles patrons de la sql</td>
</tr>

<tr>
<td>buffer</td>
<td>No</td>
<td>Nombre d&rsquo;insercions a la base de dades que es fan a la vegada  Valor per defecte:1</td>
</tr>

<tr>
<td>commit</td>
<td>No</td>
<td>Especificar si es vol autocommit en cada inserció.  Valor per defecte:true</td>
</tr>

<tr>
<td>dbclass</td>
<td>Sí</td>
<td>Driver utilitzat (específic de la BD)</td>
</tr>

<tr>
<td>quoteReplace</td>
<td>No</td>
<td>Indicar &lsquo;true&rsquo; si es volen reemplaçar les cometes simples (&lsquo;) per poder inserir a la base de dades</td>
</tr>

<tr>
<td>layoutPartsDelimiter</td>
<td>No</td>
<td>Delimitador dels patrons de layout.  És la cadena que utilitzarem per separar els diferents patrons definits dins del tag ConversionPattern del tag Layout.  Podrem escollir el patró que volem usar en cada columna indicant @LAYOUT:num_del_patro@  Ex: <param name="ConversionPattern" value="patro1#~~#patro2#~~#patro3"/>  On layoutPartsDelimiter=&ldquo;#-#&rdquo;</td>
</tr>
</tbody>
</table>

<p>Patrons del paràmetre sql:</p>

<table>
<thead>
<tr>
<th><strong>Patró</strong></th>
<th><strong>Descripció</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td>(INC)</td>
<td>Comptador incremental per cada traça</td>
</tr>

<tr>
<td>(PRIO)</td>
<td>Prioritat de la traça (DEBUG, INFO,&hellip;)</td>
</tr>

<tr>
<td>(ID)</td>
<td>Classe que implementa JDBCIDHandler i que proporciona el valor per aquesta columna.</td>
</tr>

<tr>
<td>(IPRIO)</td>
<td><strong>Prioritat de la traça en format numèric</strong></td>
</tr>

<tr>
<td>(DYNAMIC)</td>
<td>Valor dinàmic que proporciona una classe que implementa JDBCColumnHandler</td>
</tr>

<tr>
<td>(STATIC)</td>
<td>Valor estàtic</td>
</tr>

<tr>
<td>(CAT)</td>
<td>Nom de la categoria</td>
</tr>

<tr>
<td>(THREAD)</td>
<td>Nom del thread</td>
</tr>

<tr>
<td>(MSG)</td>
<td>Missatge de la traça sense format</td>
</tr>

<tr>
<td>(LAYOUT)</td>
<td>Missatge de la traça formatejat amb el patró especificat en el param ConversionPattern.</td>
</tr>

<tr>
<td>@LAYOUT:num_patró@</td>
<td>Missatge de la traça formatejat amb el patró especificat en el param ConversionPattern, en la posició indicada per num_patró</td>
</tr>

<tr>
<td>(TIMESTAMP)</td>
<td>Moment en que es llença de la traça</td>
</tr>

<tr>
<td>(THROWABLE)</td>
<td>Error associat a la traça</td>
</tr>

<tr>
<td>(NDC)</td>
<td>Informació contextual de la traça <em>(nested diagnostic context)</em></td>
</tr>

<tr>
<td>@MDC:key@</td>
<td>Informació contextual de la traça sota una clau predeterminada <em>(mapped diagnostic context)</em></td>
</tr>
</tbody>
</table>

<p>Exemple:</p>

<pre><code class="language-code-java">&lt;appender name=&quot;JDBCPooled&quot; class=&quot;org.apache.log4j.jdbcplus.JDBCAppender&quot;&gt;
    &lt;param name=&quot;url&quot; value=&quot;jdbc:mysql://localhost/test&quot; /&gt;
    &lt;param name=&quot;username&quot; value=&quot;eulo&quot; /&gt;
    &lt;param name=&quot;password&quot; value=&quot;eulo&quot; /&gt;
    &lt;param name=&quot;sql&quot; value=&quot;INSERT INTO TEST (prio, cat, thread,
    msg, layout_msg, throwable, ndc, mdc, mdc2, info, addon, created_by)
    VALUES (' (PRIO)', ' (CAT)', ' (THREAD)', ' (MSG)', '@LAYOUT:1@',
    ' (THROWABLE)', ' (NDC)', '@MDC:MyMDC@', '@MDC:MyMDC2@', 'info timestamp:
    (TIMESTAMP)', 'addon', 'me')&quot;/&gt;
    &lt;param name=&quot;buffer&quot; value=&quot;1&quot;/&gt;
    &lt;param name=&quot;commit&quot; value=&quot;true&quot;/&gt;
    &lt;param name=&quot;dbclass&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;
    &lt;param name=&quot;quoteReplace&quot; value=&quot;true&quot;/&gt;
    &lt;param name=&quot;throwableMaxChars&quot; value=&quot;3000&quot;/&gt;
    &lt;param name=&quot;layoutPartsDelimiter&quot; value=&quot;#-#&quot;/&gt;
    &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
    &lt;param name=&quot;ConversionPattern&quot; value=&quot;[%t] %m####%d\{dd.MM.yyyy\}
    #-#%d\{HH:mm:ss\}&quot;/&gt;
&lt;/layout&gt;
&lt;/appender&gt;
</code></pre>

<p>També podem indicar el nom de les columnes i el seu valor amb param name=&ldquo;column&rdquo; i posant a value:</p>

<p>nom_de_columna~patró~valor</p>

<p>On patró correspon a un dels possibles patrons. D&rsquo;aquesta manera no fa falta el paràmetre sql.</p>

<pre><code class="language-code-java">&lt;param name=&quot;table&quot; value=&quot;logtest&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;id~ID~org.apache.log4j.jdbcplus.
examples.MyIDHandler&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;prio~PRIO&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;cat~CAT&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;thread~THREAD&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;msg~MSG&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;layout_msg~LAYOUT&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;info~DYNAMIC~org.apache.log4j.jdbcplus.
examples.MyColumnHandler&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;mdc~MDC~MyMDC&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;created_on~TIMESTAMP&quot; /&gt;
&lt;param name=&quot;column&quot; value=&quot;created_by~STATIC~me&quot; /&gt;
&lt;param name=&quot;usePreparedStatements&quot; value=&quot;true&quot;/&gt;

&lt;param name=&quot;layoutPartsDelimiter&quot; value=&quot;#-#&quot;/&gt;
&lt;!- layout with conversion pattern -&gt;
&lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
&lt;!- conversion pattern with 4 parts separated by ##, second part is empty --&gt;
&lt;param name=&quot;ConversionPattern&quot; value=&quot;[%t] %m####%d\{dd.MM.yyyy\}#-#%
d\{HH:mm:ss\}&quot;/&gt;
&lt;/layout&gt;
</code></pre>

<h4 id="layouts">Layouts</h4>

<h5 id="patternlayout">PatternLayout</h5>

<p>Classe:
<a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/PatternLayout.html">org.apache.log4j.PatternLayout</a></p>

<p>Permet especificar la sortida amb patrons de conversió. El seu ús és equivalent a la funció printf del llenguatje C.</p>

<p>Alguns dels caràcters de conversió més interessants són (per a més referènciaconsultar la API de la classe):</p>

<table>
<thead>
<tr>
<th><strong>Caràcter</strong></th>
<th><strong>Descripció</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td>%c</td>
<td>Nom del &ldquo;logger&rdquo;</td>
</tr>

<tr>
<td>%C</td>
<td>Mostrar el nom qualificat de la classe que ha llençat el missatge.</td>
</tr>

<tr>
<td>%d</td>
<td>Mostrar la data en la que es va produir el missatge. A continuació opcionalment pot aparèixer el patró de conversió de data. Si no s&rsquo;especifica s&rsquo;utilitza per defecte <strong>ISO 8601.</strong> <br>Exemple: %d{dd MMM yyyy HH:mm:ss,SSS}.</td>
</tr>

<tr>
<td>%L</td>
<td>Número de línia a on es va llençar el missatge (<strong>no fer servir si es necessita un bon rendiment</strong>).</td>
</tr>

<tr>
<td>%m</td>
<td>Missatge</td>
</tr>

<tr>
<td>%p</td>
<td>Prioritat/nivell del missatge (WARN,&hellip;).</td>
</tr>

<tr>
<td>%X{clau}</td>
<td>Informació contextual &ldquo;clau&rdquo;</td>
</tr>

<tr>
<td>%n</td>
<td>Separador de línia (un \n).</td>
</tr>
</tbody>
</table>

<p>El resultat de l&rsquo;aplicació d&rsquo;aquests patrons són missatges de text pla
uniformement formatejats.</p>

<h5 id="xmllayout">XMLLayout</h5>

<p>Classe:
<a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/xml/XMLLayout.html">org.apache.log4j.XMLLayout</a></p>

<p>La sortida d&rsquo;aquest &ldquo;layout&rdquo; consisteix en una sèrie de &ldquo;log4j:event&rdquo;
nodes XML. Aquest &ldquo;layout&rdquo; no deixa un fitxer XML ben format, sinó que
està pensat per a ser inclòs com a entitat externa a un altre fitxer per
a formar un fitxer XML correcte.</p>

<p>Per exemple, si abc és el nom del fitxer a on van les traces, el fitxer
XML correcte seria:</p>

<pre><code class="language-code-java">&lt;?xml version=1.0&quot;?&gt;
&lt;!DOCTYPE log4j*:*eventSet **
    &lt;!ENTITY* data SYSTEM  &quot;*file:///abc&quot;&gt;]&gt;
          &lt;log4j:eventSet version=&quot;1.2&quot;  xmlns:log4j=&quot;http://jakarta.apache.org/log4j/&quot;&gt;
              &amp;data;
          &lt;/log4j:eventSet&gt;
</code></pre>

<p>Qualsevol informació de tipus contextual (com ara l&rsquo;userId) s&rsquo;ha
d&rsquo;incloure dins la informació contextual del log i automàticament
s&rsquo;inclourà en la traça:</p>

<pre><code class="language-code-java">&lt;log4j:event logger=&quot;net.gencat.ctti.canigo.services.logging.test.
LoggingClient&quot; timestamp=&quot;1127746730256&quot; level=&quot;DEBUG&quot; thread=&quot;main&quot;&gt;
&lt;log4j:message&gt;&lt;![CDATA[Log property file: log4j-test.xml.es-c7pym1j]]&gt;&lt;/log4j:message&gt;
&lt;log4j:NDC&gt;&lt;![CDATA[userId: me]]&gt;&lt;/log4j:NDC&gt;
&lt;/log4j:event&gt;
</code></pre>

<h5 id="patternxmllayout">PatternXMLLayout</h5>

<p>Classe:
<a href="http://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/xml/XMLLayout.html">org.apache.log4j.XMLLayout</a></p>

<p>La sortida d&rsquo;aquest &ldquo;layout&rdquo; és una combinació de PatternLayout i
XMLLayout.</p>

<p>A l&rsquo;igual que l&rsquo;XMLLayout, aquest &ldquo;layout&rdquo; no deixa un fitxer XML ben
format, si no que també està pensat per a ser inclòs com a entitat
externa a un altre fitxer per a formar un fitxer XML correcte.<br />
 El fitxer xml resultant tindrà una estructura semblant a XMLLayout, amb
la diferència que el atributs no seran els de l&rsquo;XMLLayout(<em>loggin,
timestamp, level i thread</em>), sinó que els podrem definir nosaltres
mateixos, seguint els patrons de PatternLayout.</p>

<p>Es permet definir els següents paràmetres:</p>

<table>
<thead>
<tr>
<th><strong>Paràmetre</strong></th>
<th><strong>Requerit</strong></th>
<th><strong>Descripció</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td>NameSpace</td>
<td>Sí</td>
<td>Indica el namespace que l&rsquo;xml mostrarà en els tags (<name_space:event>). Si no es defineix, mostrarà únicament el nom del tag (<event>)</td>
</tr>

<tr>
<td>NodeName</td>
<td>Sí</td>
<td>Indica el nom del node principal(<registre>). Per defecte és &ldquo;event&rdquo; (<event>)</td>
</tr>

<tr>
<td>AttrValuePairDelim</td>
<td>Sí</td>
<td>Indica quin caràcter servei de separador entre un atribut i el seu valor (usar &lsquo;=&rsquo; per defecte).</td>
</tr>

<tr>
<td>AttrVarDelim</td>
<td>Sí</td>
<td>Indica quin caràcter serveix de separador entre els diferents atributs</td>
</tr>

<tr>
<td>AttrConversionPattern</td>
<td>Sí</td>
<td>Defineix els diferents atributs dels events del log. El valor dels atributs pot seguir els mateixos patrons que en <em>PatternLayout.</em></td>
</tr>

<tr>
<td>NodesValuePairDelim</td>
<td>Sí</td>
<td>Indica quin caràcter serveix de separador entre els noms dels nodes i el seu valor</td>
</tr>

<tr>
<td>NodesVarDelim</td>
<td>Sí</td>
<td>Indica __quin caràcter serveix de separador entre els diferents nodes</td>
</tr>

<tr>
<td>NodesConversionPattern</td>
<td>Sí</td>
<td>Defineix els diferents nodes dels events del log. El valor dels nodes també pot seguir els mateixos patrons que en PatternLayout.</td>
</tr>

<tr>
<td>Throwable</td>
<td>Sí</td>
<td>Indica que es mostraran les excepcions llançades. A value definirem el nom del tag que inclourà l&rsquo;excepció.</td>
</tr>

<tr>
<td>ExceptionMaxLength</td>
<td>No</td>
<td>Indica el nombre màxim de caràcters que mostrarem de l&rsquo;excepció. Per defecte són 256 caràcters.</td>
</tr>
</tbody>
</table>

<p>Exemple:</p>

<pre><code class="language-code-java">&lt;appender name=&quot;file&quot; class=&quot;org.apache.log4j.RollingFileAppender&quot;&gt;
&lt;param name=&quot;File&quot; value=&quot;D:/logs/logging4.log.xml&quot;/&gt;
&lt;param name=&quot;Append&quot; value=&quot;true&quot;/&gt;
&lt;param name=&quot;MaxFileSize&quot; value=&quot;50KB&quot;/&gt;
&lt;param name=&quot;maxBackupIndex&quot; value=&quot;3&quot;/&gt;
&lt;layout class=&quot;net.gencat.ctti.canigo.services.logging.log4j.xml.PatternXMLLayout&quot;&gt;
&lt;param name=&quot;NameSpace&quot; value=&quot;log4j&quot;/&gt;
&lt;param name=&quot;NodeName&quot; value=&quot;registre&quot;/&gt;
&lt;param name=&quot;AttrValuePairDelim&quot; value=&quot;=&quot;/&gt;
&lt;param name=&quot;AttrVarDelim&quot; value=&quot;;&quot;/&gt;
&lt;param name=&quot;AttrConversionPattern&quot; value=&quot;attr1=%-5p;attr2=%t;attr3=%c&quot; /&gt;
&lt;param name=&quot;NodesValuePairDelim&quot; value=&quot;=&quot;/&gt;
&lt;param name=&quot;NodesVarDelim&quot; value=&quot;;&quot;/&gt;
&lt;param name=&quot;NodesConversionPattern&quot; value=&quot;data=%d\{yyyy MM dd HH:mm:ss\};
errorType=0;aplicacio=%c;logger=%F;nivell=%p;classe=%c;metode=metode; pid=%t;
missatge=%m;user_id=%X\{userId\};pagOrigen=%X\{pagOrigen\};&quot; /&gt;
&lt;param name=&quot;Throwable&quot; value=&quot;textException&quot;/&gt;
&lt;param name=&quot;ExceptionMaxLength&quot; value=&quot;256&quot;/&gt;
&lt;/layout&gt;
&lt;/appender&gt;

Un exemple de sortida amb aquesta configuració és:

&lt;log4j:registre
attr1=&quot;ERROR&quot;
attr2=&quot;SNMP Server&quot;
attr3=&quot;net.gencat.ctti.canigo.services.logging.snmp.test.TestListener&quot;&gt;
&lt;log4j: Data&gt;2005 10 13 13:29:21&lt;/log4j: Data&gt;
&lt;log4j:errorType&gt;0&lt;/log4j:errorType&gt;
&lt;log4j:aplicacio&gt;net.gencat.ctti.canigo.services.logging.snmp.test.TestListener&lt;/log4j:aplicacio&gt;
&lt;log4j:logger&gt;Log4JLog.java&lt;/log4j:logger&gt;
&lt;log4j:nivell&gt;ERROR&lt;/log4j:nivell&gt;
&lt;log4j:classe&gt;net.gencat.ctti.canigo.services.logging.snmp.test.TestListener&lt;/log4j:classe&gt;
&lt;log4j:metode&gt;metode&lt;/log4j:metode&gt;
&lt;log4j: Pid&gt;SNMP Server&lt;/log4j: Pid&gt;
&lt;log4j:textException&gt;&lt;![CDATA[java.lang.Exception: Exception Message
at net.gencat.ctti.canigo.services.logging.snmp.test.TestListener.snmpRequest(TestListener.java:38)
at ca.wengsoft.snmp.Core.SnmpDispatcher.notifyEvent(SnmpDispatcher.java:164)
at ca.wengsoft.snmp.Core....]]&gt;
&lt;/log4j:textException&gt;
&lt;/log4j:registre&gt;

En cas que no s'hagués definit el paràmetre NameSpace obtindrem aquest altre format:

&lt;registre
attr1=&quot;ERROR&quot;
attr2=&quot;SNMP Server&quot;
attr3=&quot;net.gencat.ctti.canigo.services.logging.snmp.test.TestListener&quot;&gt;

&lt;data&gt;2005 10 13 13:30:40&lt;/data&gt;
&lt;errorType&gt;0&lt;/errorType&gt;
&lt;aplicacio&gt;net.gencat.ctti.canigo.services.logging.snmp.test.TestListener&lt;/aplicacio&gt;
&lt;logger&gt;Log4JLog.java&lt;/logger&gt;
&lt;nivell&gt;ERROR&lt;/nivell&gt;
&lt;classe&gt;net.gencat.ctti.canigo.services.logging.snmp.test.TestListener&lt;/classe&gt;
&lt;metode&gt;metode&lt;/metode&gt;
&lt;pid&gt;SNMP Server&lt;/pid&gt;
&lt;textException&gt;&lt;![CDATA[java.lang.Exception: Exception Message
at net.gencat.ctti.canigo.services.logging.snmp.test.TestListener.snmpRequest(TestListener.java:38)
at ca.wengsoft.snmp.Core.SnmpDispatcher.notifyEvent(SnmpDispatcher.java:164)
at ca.wengsoft.snmp.Core....]]&gt;
&lt;/textException&gt;

&lt;/registre&gt;
</code></pre>

<p><strong>Incorporació de valors comuns a l&rsquo;aplicació</strong></p>

<p>Utilitzant aquest layout podem crear logs amb valors provinents de
variables ja especificades en qualsevol punt de l&rsquo;aplicació.
 Exemple: Imaginem que el filtre d&rsquo;autentificació obté l&rsquo;usuari i volem
mostrar l&rsquo;usuari connectat a les nostres traces.
 Una possible opció és que la classe que generés la traça accedís
prèviament a l&rsquo;obtenció de l&rsquo;usuari connectat (a la sessió, cridant a la
classe d&rsquo;autentificació, etc.) i afegís aquesta informació a la traça.
Aquesta opció és costosa i poc mantenible. Si volem mostrar a totes les
traces de la nostra aplicació l&rsquo;usuari connectat haurem de realitzar
aquest procediment. I si després ens demanen que s&rsquo;afegeixi altra
informació contextual a totes les traces de l&rsquo;aplicació?
 Per evitar aquestes problemàtiques canigo proporciona la classe &lsquo;
net.gencat.ctti.canigo.core.threadlocal.ThreadLocalProperties&rsquo;.
 ThreadLocalProperties.put(&ldquo;userId&rdquo;,&ldquo;Usuari1&rdquo;);
 Una vegada introduït en qualsevol punt de l&rsquo;aplicació aquest atribut,
podem configurar al layout que es mostri aquesta informació utilitzant
el caràcter &lsquo;$&rsquo; seguit del nom del atribut.
 Exemple:</p>

<pre><code class="language-code-java">&lt;param name=&quot;NodesConversionPattern&quot; value=&quot;data=%d\{yyyy MM dd  HH:mm:ss\};user_id=$userId;&quot; /&gt;
</code></pre>

<p>Aquest paràmetre crearia un tag amb un node &lsquo;<em>data&rsquo;</em> obtingut amb el
patró de conversió indicat i un tag &lsquo;<em>user_id&rsquo;</em> amb el valor del
paràmetre <em>userId</em> obtingut de l&rsquo;objecte &lsquo;ThreadLocalProperties&rsquo;:</p>

<pre><code class="language-code-java">&lt;log4j:registre&gt;
    &lt;log4j: Data&gt;2005 10 19 11:29:40&lt;/log4j:  Data&gt;
    &lt;log4j:user_id&gt;Usuari1&lt;/log4j:user_id&gt;
&lt;/log4j:registre&gt;
</code></pre>

<ul>
<li>Incorporació de missatges estructurats a la traça*</li>
</ul>

<p>Per lo general els missatges de traces són cadenes. Si volem generar
informació adicional estructurada farem ús de l&rsquo;objecte
BaseLoggingObject per afegir la informació (veure apartat &lsquo;Utilització -
Generar logs amb paràmetres adicionals a un missatge&rsquo;).</p>

<p>Per mostrar els atributs de l&rsquo;objecte BaseLoggingObject s&rsquo;usarà la
sintaxi &lsquo;<strong>@</strong>&rsquo; seguida del nom del paràmetre.</p>

<p><param name="NodesConversionPattern" value="idTramit=@idTramit;" /></p>

<h2 id="utilització-del-servei">Utilització del Servei</h2>

<h3 id="generar-missatges">Generar Missatges</h3>

<p>Per generar una traça en nivell debug tindriem el següent codi:</p>

<pre><code class="language-code-java">public class ExempleTrace{

   private static final Log LOGGER = LogFactory.getLog(ExempleTrace.class);

   public void execute(){
      if (LOGGER.isDebugEnabled()){
         LOGGER.debug(&quot;Traça d'exemple&quot;);
      }
   }

}
</code></pre>

<h3 id="recomanacions">Recomanacions</h3>

<h4 id="recomanacions-generals">Recomanacions generals</h4>

<ul>
<li>Mai utilitzar System.out.println.</li>
<li>Instancia de manera estàtica i final el log per evitar
instanciacions innecessàries.</li>
<li>Sobreescriu sempre el mètode toString() per donar una representació
del objecte. Obtenir una traça del tipus className@16cd7d5 no aporta
res.</li>
<li>Valida el nivell de traces abans d&rsquo;escriure.</li>
</ul>

<h4 id="recomanacions-davant-excepcions">Recomanacions davant excepcions</h4>

<ul>
<li>No utilitzar e.printStackTrace.</li>
</ul>

<p>e.printStackTrace només imprimeix en consola. Només es podrà visualitzar
aquesta informació si s&rsquo;ha definit un appender de consola.</p>

<pre><code class="language-code-java">try {
   ................
} catch ( unaException e) {
    e.printStackTrace();
}
</code></pre>

<p>Utilitzar LOGGER.error(message, t) on t es la excepció capturada:</p>

<pre><code class="language-code-java">try {
    ................
} catch (MyException e) {
    LOGGER.error(&quot;S'ha produït un error: &quot;, e);
    .........................
}
</code></pre>

<ul>
<li>No utilitzar LOGGER.error i després rellançar l&rsquo;excepció si no és
estrictament necessari:</li>
</ul>

<pre><code class="language-code-java">try {
    ................
} catch (MyException e) {
    LOGGER.error(&quot;S'ha produït un error: &quot;, e);
    throw e;
}
</code></pre>

<p>Si en altres nivells es fa el mateix, s&rsquo;imprimirà les excepcions
diverses vegades, portant a la confusió.</p>

<ul>
<li>No eliminar el stacktrace</li>
</ul>

<pre><code class="language-code-java">try{
    ......
}catch(MyException e){
    throw new RuntimeException(&quot;S'ha produït un error: &quot; + e.getMessage());
}
</code></pre>

<p>Aquest codi elimina el stacktrace de MyException. Es perd informació
útil sobre la excepció. La alternativa correcta és:</p>

<pre><code class="language-code-java">try{
   ...
}catch(MyException e){
   throw new RuntimeException(&quot;S'ha produït un error: &quot;, e);
}
</code></pre>

<h4 id="evitar-càlculs-innecessaris">Evitar càlculs innecessaris</h4>

<p>Una de les qüestions més importants del sistema de traces és el cost de
computació. Si en un moment donat es desactiven determinats nivells de
traces, tot i que aquesta traça no es generi a la sortida el missatge és
avaluat (ja que es troba com un paràmetre de la crida). Si l&rsquo;avaluació
del missatge comporta càlculs estem afegint un cost innecessari.</p>

<p>Per evitar afegir costos addicionals de còmput innecessari es recomana
prèviament comprovar que es troba activat el nivell pel qual generarem
el missatge. Així, per exemple, enlloc de:</p>

<pre><code class="language-code-java">LOGGER.debug(&quot;....&quot;);
</code></pre>

<p>Haurem sempre de realitzar:</p>

<pre><code class="language-code-java">if (LOGGER.isDebugEnabled())
LOGGER.debug(&quot;....&quot;);
</code></pre>

<h4 id="programació-de-traces">Programació de traces</h4>

<p>Com a recomanació de traces i nivell d&rsquo;aquestes dins d&rsquo;un mètode podrien
ser les següents:</p>

<ol>
<li>Traça a nivell debug al començament del mètode, informant els
paràmetres d&rsquo;entrada que poden arribar a ser útils per a detectar
l&rsquo;operació realitzada.</li>
<li>Traça a nivell info informant de l&rsquo;operació realitzada, si
procedeix.</li>
<li>Traça a nivell error o warn per a blocs destinats a la captura
d&rsquo;excepcions.</li>
</ol>

<pre><code class="language-code-java">public void inserirUsuari(String nom){
try {
      if (LOGGER.isDebugEnabled()) {
    LOGGER.debug(&quot;UsuarioDAOImpl:eliminarUsuario ...identificador del usuario:&quot; + identificadorUsuario);
      }

      User user = new User();
      user.setName(nom);
      getUserDAO().insert(user);

      if (LOGGER.isInfoEnabled()) {
     LOGGER.info(&quot;Usuari &quot; + user + &quot; inserit a la BD&quot;);
      }

 }
 catch (Exception e) {
    LOGGER.error(&quot;S'ha produït un error, e);
    ........
 }
}
</code></pre>

<h3 id="generar-informació-contextual">Generar Informació Contextual</h3>

<p>Moltes vegades no és suficient amb la informació estàndard que es mostra
a les traces i és necessari complementar-la amb informació contextual
cóm: usuari que fa la petició, temps d&rsquo;inici i final, etc. Per afegir
aquesta informació, és necessari inicialitzar-la en algun moment de la
petició per què estigui disponible durant tot el processat de la
mateixa. Per tant, el patró de treball a seguir és:</p>

<ol>
<li>Inicialització de l&rsquo;informació addicional abans de processar la
petició.</li>
<li>Processat de la petició (utilització de l&rsquo;informació addicional en
el mòdul de traces).</li>
<li>Finalització de la petició.</li>
</ol>

<p><strong>Canigó</strong> suporta la inserció d&rsquo;aquesta informació mitjançant la
extensió del filtre
LoggingFilter.
Gracies al mètode createCustomParameters, el desenvolupador pot afegir o
eliminar paràmetres de la Mapped Diagnostic Context (MDC) de Log4j que
posteriorment seran inserits a les traces de l&rsquo;aplicació.</p>

<p>Un exemple de filtre que afegeix informació de l&rsquo;usuari, adreça i host
remot a les traces podria ser:</p>

<pre><code class="language-code-java">...
public class ExtendedLoggingFilter extends LoggingFilter {

     private final static String USERNAME = &quot;USERNAME&quot;;
     private final static String REMOTEHOST = &quot;REMOTEHOST&quot;;
     private final static String REMOTEADDR = &quot;REMOTEADDR&quot;;

     @Override
     protected Map&lt;String, Object&gt; createCustomParameters( ServletRequest request, ServletResponse response) {

           Map&lt;String,Object&gt; custom = new HashMap&lt;String, Object&gt;();
       custom.put(REMOTEHOST, request.getRemoteHost());
           custom.put(REMOTEADDR, request.getRemoteAddr());

       HttpServletRequest httprequest = (HttpServletRequest) request;
           String userLogin = (String)httprequest .getSession().getAttribute(&quot;userLogin&quot;);

            if (userLogin!=null) {
                custom.put(USERNAME, userLoginId);
            }

           return custom;
     }
}
</code></pre>

<p>Configuració del layout per a mostrar les dades:</p>

<pre><code class="language-code-java">&lt;appender name=&quot;console&quot; class=&quot;org.apache.log4j.ConsoleAppender&quot;&gt;
    &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
        &lt;param name=&quot;ConversionPattern&quot; value=&quot;%-4r [%t] %5p %c %x - %m - %X{USERNAME}%n - %X{REMOTEHOST} - %X{REMOTEADDR}&quot;/&gt;
    &lt;/layout&gt;
&lt;/appender&gt;
</code></pre>

<h2 id="eines-de-suport">Eines de Suport</h2>

<h3 id="java-templates-per-a-eclipse">Java Templates per a Eclipse</h3>

<p>Eclipse ofereix unes eines que faciliten o agilitzen la creació de codi
repetitiu.</p>

<p>Dins d&rsquo;Eclipse:
 <strong>Window -&gt; Preferences -&gt; Java -&gt; Editor -&gt; Templates.</strong></p>

<p>Creem un nou template amb el nom <strong>log</strong>:</p>

<pre><code class="language-code-java">private static final ${loggerType:newType(org.apache.commons.logging.Log)} logger =
   ${logFactoryType:newType(org.apache.commons.logging.LogFactory)}
   .getLog(${enclosing_type}.class);
</code></pre>

<p>Un cop ja a la classe, si escrivim <strong>log</strong> seguit de CTRL + BARRA ESPAI.
Eclipse ens crearà el següent codi automàticament:</p>

<pre><code class="language-code-java">private static final Log LOGGER= LogFactory.getLog(NomClasse.class);
</code></pre>

<p>Un altre template interessant és el següent:</p>

<pre><code class="language-code-java">if (LOGGER.isDebugEnabled()) {
   LOGGER.debug(${msg});
}
</code></pre>

<p>Que generaria el codi recomanat per a traces de nivell DEBUG.</p>

<h2 id="annexos">Annexos</h2>

<h3 id="introducció-a-log4j">Introducció a Log4J</h3>

<p>En aquest annex s&rsquo;ofereix una breu introducció a conceptes de Log4J que
cal entendre per utilitzar el Servei de Traces.</p>

<p>A Log4J, existeixen varis elements clau:</p>

<ol>
<li><p>Prioritats o nivells de les traces. Log4J defineix per defecte 5
nivells: DEBUG, INFO, WARN, ERROR i FATAL. Entre ells existeix una
jerarquia (DEBUG&lt;INFO&lt;WARN&lt;ERROR&lt;FATAL), de forma que si en
l&rsquo;aplicació s&rsquo;ha configurat que només es mostrin traces de nivell
WARN, també es mostrarien els de nivell ERROR i FATAL.</p>

<p><img src="/related/canigo/documentacio/modul-traces/ServeiTraces_img014.jpg" alt="" /></p></li>

<li><p>Categories. Les categories donen control al programador per a
determinar quins events requereixen ser capturats i quins no. Dins
de l&rsquo;aplicació es poden definir diferents categories organitzades
per jerarquia que en la majoria dels casos es mapejen amb el nom
qualificat de les classes java, a on cada classe tindria la seva
categoria. També poden crear-se categories per nom, de manera que
podria definir-se una categoria que fes traces de les conexions RMI
de l&rsquo;aplicació, o de totes les operacions del usuari, etc.</p></li>

<li><p>Appenders. Els &ldquo;appenders&rdquo; especifiquen a on es desarà la traça
definida per a la categoria. Una categoria pot definir diferents
sortides o &ldquo;appenders&rdquo; a la vegada (consola, fitxer, correu
electrònic, base de dades,etc.)</p></li>

<li><p>Layouts. Permeten especificar com es mostren els events. Per exemple
podem especificar que ens aparegui l&rsquo;hora en la que s&rsquo;ha produït
l&rsquo;event, qui ho ha llençat, la línia en la que s&rsquo;ha fet, etc.</p></li>
</ol>


					

					
				</div>	

			</article>	


	</section>	

		<div class="fons_footer ">
		<footer class="container center-block shadowBox2">
			<div class="shadow2"></div>
			<div class="row footer_tab_ord">

				<div class="footer_tab_bot col-sm-12">
					<div class="avis_legal">

						<div id="fAvisLegal">
							<div>
								<div class="hidden-xs">
									<a href="http://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" alt="www.gencat.cat"
										/></a>
									<p>
										<a title="Avis legal" href="http://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								<div class="visible-xs avis_legal">
									<p>
										<a title="Avis legal" href="http://web.gencat.cat/ca/menu-ajuda/ajuda/avis_legal/" target="_self">Avís legal</a>: La &copy; Generalitat de Catalunya permet la reutilització dels continguts i de les dades sempre que se citi la font i la data d'actualització, que no es desnaturalitzi la informació i que no es contradigui amb una llicència específica.
									</p>
								</div>
								
								<div class="fi_peu visible-xs">
									<a title="www.gencat.cat" href="http://www.gencat.cat"> <img
										src="/img/logo_generalitat_gris.png_679097835.png"
										width="101" height="27" 
										alt="www.gencat.cat" /></a> <a class="torna_amunt pull-right"
										href=" javascript:tornarAmunt();" title="Torna amunt">
										<p>Torna amunt</p>
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
	</div>

<script src="/js/master.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
<script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
<script src="/js/custom.js" type="text/javascript"></script>



<script type="text/javascript">

if(location.hostname!=="localhost"){

	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', "UA-59408075-1", 'auto');
	ga('send', 'pageview', {
	  	'page': location.pathname + location.search  + location.hash
	  }
	);

}

</script>



</body>
</html>
